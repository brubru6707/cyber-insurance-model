<html>
<head>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Pixelify+Sans&family=Work+Sans:wght@300&display=swap");

    :root {
      --pri: purple;
      --urg: red;
    }

    body {
      margin: 0px;
      padding: 0px;
      background-color: black;
      color: white;
      height: 200vh;
      font-family: "Pixelify Sans", sans-serif;
      font-size: larger;
    }

    header {
      text-align: center;
    }

    h2 {
      text-align: center;
    }

    section {
      margin-bottom: 60px;
    }

    #mod-cont {
      display: flex;
      flex-flow: column nowrap;
    }

    #timer {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 20px;
      font-weight: bolder;
      background-color: black;
      border-radius: 10px;
      padding: 2px;
    }

    #controls {
      position: fixed;
      width: 200px;
      text-align: center;
      border-radius: 15px;
      padding: 10px;
      font-size: 20px;
      font-weight: bolder;
      background-color: purple;
      bottom: 20px;
      left: calc(-100px + 50vw);
      display: flex;
      flex-flow: row nowrap;
      justify-content: space-around;
      z-index: 100;
    }

    #mal-alert {
      text-align: center;
      padding: 10px;
      width: 30vw;
      margin-left: 35vw;
      height: fit-content;
      border-radius: 1px;
      font-size: 20px;
      font-weight: bolder;
      background-color: rgb(185, 33, 33);
    }

    #controls>div {
      padding: 10px;
    }

    #controls>div:hover {
      cursor: pointer;
      background-color: blue;
    }

    #stats {
      text-align: start;
      margin-left: 10px;
    }

    #evidence,
    #logic {
      background-color: rgb(238, 208, 255);
      color: black;
      font-weight: bolder;
      padding: 10px;
    }

    #evidence>p,
    #logic>p {
      margin-left: 30px;
    }

    .insur-tot-prof,
    #insurer-tot-prof {
      text-decoration: underline;
      color: green;
    }

    #model-chart {
      margin: auto;
      width: 70vw;
      height: 40vw;
    }

    .comps-table-w-insur {
      display: flex;
      flex-flow: row nowrap;
      margin-bottom: 10px;
    }

    .comps-w-insur[value="false"]>comp-unit {
      transform: translateX(10%);
    }

    .comps-w-insur[value="true"]>comp-unit {
      transform: translateX(-10%);
    }

    .comps-w-insur {
      display: flex;
      flex-flow: row wrap; /* Changed to wrap */
      justify-content: center;
      width: 85%;
    }

    .row-title {
      width: 15%;
      text-align: center;
      padding: 10px;
    }

    .comp {
      padding: 10px;
      display: inline-block;
      border-radius: 10px;
      background-color: var(--pri);
      width: 120px;
      height: 120px;
      margin-right: 40px;
      margin-bottom: 10px; /* Added for wrap */
      text-align: center; /* Added for consistency */
    }

    .att {
      animation: 1s linear att-ani;
    }

    .pop-up {
      text-align: center;
      position: relative;
      top: -125px; /* Adjusted */
      left: 0; /* Adjusted */
      background-color: blue;
      padding: 5px;
      border-radius: 3px;
      display: none;
      color: white; /* Added */
    }

    .act-pop-up {
      display: block;
      animation: 1s linear pop-up-ani;
    }

    @keyframes pop-up-ani {
      0% {
        opacity: 1;
        top: -100px;
      }
      100% {
        opacity: 0;
        top: -150px;
      }
    }

    @keyframes att-ani {
      0% {
        background-color: purple;
      }
      50% {
        background-color: red;
      }
      100% {
        background-color: purple;
      }
    }
  </style>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <header>
    <h1>Cyber Insurance Model</h1>
  </header>
  <div id="timer">0</div>
  <section id="comps-table">
    <div class="comps-table-w-insur" value="true">
      <div class="row-title">
        <h4>Companies With Cyber Insurance</h4>
      </div>
      <div class="comps-w-insur" value="true"></div>
    </div>
    <div class="comps-table-w-insur" value="false">
      <div class="row-title">
        <h4>Companies With No Cyber Insurance</h4>
      </div>
      <div class="comps-w-insur" value="false"></div>
    </div>
  </section>
  <section id="mal-alert">ATTACK TYPE</section>
  <br>
  <section id="stats">
    No Cyber Insurance Total Profit:
    <span class="insur-tot-prof" id="no-insur-tot-prof">0</span>$
    <br>
    <br>
    Cyber Insurance Total Profit:
    <span class="insur-tot-prof" id="insur-tot-prof">0</span>$
    <br>
    <br>
    Cyber Insurer Total Profit:
    <span id="insurer-tot-prof" value="1000">1000</span>$
    <br>
  </section>
  <section id="stats-2">
    <div id="model-chart"></div>
  </section>
  <br>
  <section id="evidence">
    <h2><u>Reasoning</u></h2>
    <p>
      &gt; Small Buisness have to pay around 145$ monthly for their Cyber
      Insurance policy
    </p>
    <p>
      &gt; Buisness that have Cyber Insurance are less likely to get hit with
      malware
    </p>
    <p>
      &gt; After a company gets hit with a multitude of cyber attacks, their
      popularity and reputation dwindle and they die
    </p>
  </section>

  <section id="logic">
    <h2><u>Logic</u></h2>
    <p>&gt; 70% chance that a company with no cyber insurance will get hit</p>
    <p>&gt; 1s manes 1 attack for a random company</p>
    <p>&gt; Companies with cyber insurance give 145$ to cyber insurance</p>
    <p>
      &gt; Companies that get hit with a cyber attack have to pay around 1000$ to
      around 2000$
    </p>
    <p>
      &gt; Companies with cyber insurance lose 1 popularity while companies with
      no cyber insurance lost around 1-3
    </p>
    <p>&gt; Popularity is directly related to monthly profit</p>
    <p>
      &gt; If a company with cyber insurance gets hit, the cyber insurer has to
      pay the cyber attack amount plus 1000$
    </p>
  </section>
  <div id="controls">
    <div id="speed-time">Speed</div>
    <div id="slow-time">Slow</div>
    <div id="stop-time">Stop</div>
  </div>
  <footer>
    <script>
      // --- MODEL VARIABLES ---
      let brandArr = ['Google', 'Facebook', 'Yahoo', 'Microsoft', 'Intel', 'Dell', 'Canva', 'JsFiddle', 'Grammarly', 'Lake Meadow', 'JennyAI', 'OpenAI'];
      let atts = ["man-in-the-middle", "over-the-shoulder", "sim swapping", "piracy", "brute force", "ransomware", "virus", "trojan", "worm", "insider", "Regin"];
      let compObjs = [];
      let timVal = 0;
      let insurTotProfVal = 1000;
      let insurCompsTotProfs = {
        "noInsur": 0,
        "insur": 0
      };
      let profRan = 500;
      let compAm = 5; // This will create 5 *with* and 5 *without* insurance
      let loopInterval;
      let loopSpeed = 1000; // 1s per tick, as per logic

      // --- DOM ELEMENTS (from V2) ---
      const noInsurCompCont = document.querySelector('.comps-w-insur[value="false"]');
      const insurCompCont = document.querySelector('.comps-w-insur[value="true"]');
      const timValCont = document.getElementById('timer');
      const insurProfTotValCont = document.getElementById("insurer-tot-prof");
      const insurCompsTotProfValCont = document.getElementById("insur-tot-prof");
      const noInsurCompsTotProfValCont = document.getElementById("no-insur-tot-prof");
      const attCont = document.getElementById("mal-alert");

      // --- CHART VARIABLES ---
      let chartData;
      let chart;
      let chartOptions;

      // --- CORE FUNCTIONS (Adapted from V1) ---

      let createCompObj = (insuranceTF) => {
        let randBrandName = brandArr[Math.floor(Math.random() * brandArr.length)];
        brandArr = brandArr.filter(e => e !== randBrandName);
        let prof = Math.floor(Math.random() * profRan) + 300;
        return {
          'name': randBrandName || `COMP${Math.random()}`, // Fallback name
          'totProf': 0,
          'prof': prof, // This is now "profit per tick"
          'pop': 100,
          'insurTF': insuranceTF
        };
      }

      // Updated to create V2's HTML structure
      let createCompEle = (compObj) => {
        let compEle = document.createElement('comp-unit'); // V2 uses <comp-unit>
        compEle.className = "comp";
        compEle.id = compObj['name'];

        let nameEle = document.createElement('div');
        nameEle.innerText = compObj["name"];

        let totProfEle = document.createElement('span');
        totProfEle.id = `${compObj['name']}-totProf`;
        totProfEle.innerText = compObj['totProf'];

        let profEle = document.createElement('span');
        profEle.id = `${compObj['name']}-prof`;
        profEle.innerText = compObj['prof'];

        let popEle = document.createElement('span');
        popEle.id = `${compObj['name']}-pop`;
        popEle.innerText = compObj['pop'];

        let popUpEle = document.createElement('span');
        popUpEle.className = "pop-up";
        popUpEle.id = `${compObj['name']}-popup`; // ID to control the pop-up

        compEle.append(nameEle, document.createElement("br"), totProfEle, document.createElement("br"), profEle, document.createElement("br"), popEle, document.createElement("br"), popUpEle);
        return compEle;
      }

      let createCompUnit = (insuranceTF) => {
        let compObj = createCompObj(insuranceTF);
        let compEle = createCompEle(compObj);
        return [compObj, compEle];
      }

      // Updated for V2's logic
      let calcCompsTotProf = () => {
        // Reset group totals to re-calculate from scratch
        insurCompsTotProfs = { "noInsur": 0, "insur": 0 };
        for (let compObj of compObjs) {
          // Popularity directly affects profit (as per V2 logic)
          compObj['prof'] = Math.round((compObj['prof'] * compObj['pop']) / 100);
          
          // Add this tick's profit to the individual company's total
          compObj['totProf'] += compObj['prof'];
          
          if (compObj["insurTF"]) {
            compObj['totProf'] -= 145; // Pay premium (as per V2 logic)
            insurCompsTotProfs["insur"] += compObj['totProf']; // Add to group total
          } else {
            insurCompsTotProfs["noInsur"] += compObj['totProf']; // Add to group total
          }
        }
      }

      // Updated for V2's logic
      let calcInsurTotProf = (insurTF, attackCost) => {
        // Insurer gains premium from all insured companies
        insurTotProfVal += (145 * compAm);
        
        if (insurTF) {
          // Insured company was hit, insurer pays
          // V2 Logic: "pay the cyber attack amount plus 1000$"
          insurTotProfVal -= (attackCost + 1000);
        }
      }

      // Updated to render V2's structure
      let renCompObjToCompEle = () => {
        for (let compObj of compObjs) {
          document.getElementById(`${compObj['name']}-totProf`).innerText = compObj['totProf'];
          document.getElementById(compObj['name'] + '-pop').innerText = compObj['pop'];
          document.getElementById(compObj['name'] + '-prof').innerText = compObj['prof'];
        }
      }

      // Updated to V2's IDs
      let renCompsTotProf = () => {
        insurCompsTotProfValCont.innerText = insurCompsTotProfs["insur"];
        noInsurCompsTotProfValCont.innerText = insurCompsTotProfs["noInsur"];
      }

      // Updated to V2's IDs
      let renInsurTotProf = () => {
        insurProfTotValCont.innerText = insurTotProfVal;
      }

      let randAttTar = () => {
        // V2 Logic: "70% chance that a company with no cyber insurance will get hit"
        let roll = Math.random(); // 0.0 to 1.0
        let targetGroup;
        
        if (roll < 0.7) {
          // Target uninsured
          targetGroup = compObjs.filter(c => !c.insurTF);
        } else {
          // Target insured
          targetGroup = compObjs.filter(c => c.insurTF);
        }
        
        // Pick a random company *from that group*
        let randCompObj = targetGroup[Math.floor(Math.random() * targetGroup.length)];
        return randCompObj;
      }

      // Updated for V2's logic and animations
      let randAtt = (compObj) => {
        let compEle = document.getElementById(compObj['name']);
        let popUpEle = document.getElementById(`${compObj['name']}-popup`);
        let attackCost = 0;

        // V2 Logic: "pay around 1000$ to around 2000$"
        attackCost = Math.floor(Math.random() * 1001) + 1000;

        if (compObj['insurTF']) {
          // V2 Logic: "lose 1 popularity"
          compObj['pop'] -= 1;
          // Insurer pays, so no profit hit or pop-up
        } else {
          // V2 Logic: "lost around 1-3"
          compObj['pop'] -= Math.floor(Math.random() * 3) + 1;
          // Uninsured company pays the cost
          compObj['prof'] -= attackCost;
          // Show pop-up
          popUpEle.innerText = `-${attackCost}`;
          popUpEle.classList.add('act-pop-up');
        }

        // V2 Animation
        compEle.classList.add('att');
        setTimeout(() => {
          compEle.classList.remove('att');
          if (!compObj['insurTF']) {
             popUpEle.classList.remove('act-pop-up');
             popUpEle.innerText = '';
          }
        }, 1000); // Animation is 1s long

        attCont.innerText = atts[Math.floor(Math.random() * atts.length)].toUpperCase();
        
        // Return the cost so the insurer function knows what to pay
        return attackCost;
      }

      let startUp = (compAm) => {
        for (let x = 0; x < compAm * 2; x++) {
          let isInsured = !(x < compAm);
          let [compObj, compEle] = createCompUnit(isInsured);
          compObjs.push(compObj);
          // Append to V2's containers
          (isInsured ? insurCompCont.append(compEle) : noInsurCompCont.append(compEle));
        }
      }

      // --- GOOGLE CHART FUNCTIONS ---
      function initChart() {
        chartData = [['Time', 'Companies With Cyber Insurance', 'Companies With No Cyber Insurance']];
        chartData.push([0, 0, 0]); // Add initial row

        var data = google.visualization.arrayToDataTable(chartData);
        chartOptions = {
          title: 'Total Group Profit Over Time',
          curveType: 'function',
          legend: { position: 'bottom' },
          backgroundColor: '#000000',
          titleTextStyle: { color: '#FFFFFF' },
          legendTextStyle: { color: '#FFFFFF' },
          hAxis: { textStyle: { color: '#FFFFFF' }, titleTextStyle: { color: '#FFFFFF' } },
          vAxis: { textStyle: { color: '#FFFFFF' }, titleTextStyle: { color: '#FFFFFF' } }
        };
        chart = new google.visualization.LineChart(document.getElementById('model-chart'));
        chart.draw(data, chartOptions);
      }

      function updateChart() {
        chartData.push([timVal, insurCompsTotProfs["insur"], insurCompsTotProfs["noInsur"]]);
        var data = google.visualization.arrayToDataTable(chartData);
        chart.draw(data, chartOptions);
      }

      // --- SIMULATION LOOP (from V1) & CONTROLS (from V2) ---
      
      // This is the function that runs every "tick"
      function runTick() {
        let compObjTar = randAttTar();
        let attackCost = randAtt(compObjTar); // Get attack cost

        // Calculations
        calcCompsTotProf();
        calcInsurTotProf(compObjTar["insurTF"], attackCost);

        // Rendering
        renCompsTotProf();
        renCompObjToCompEle();
        renInsurTotProf();

        // Update time and chart
        timVal++;
        timValCont.innerText = timVal;
        updateChart();
      }

      // Function to (re)start the loop
      function startLoop() {
        clearInterval(loopInterval); // Clear any existing loop
        loopInterval = setInterval(runTick, loopSpeed);
      }

      // Add listeners to V2's controls
      document.getElementById('stop-time').onclick = () => {
        clearInterval(loopInterval);
      };
      document.getElementById('slow-time').onclick = () => {
        loopSpeed = 2000;
        startLoop();
      };
      document.getElementById('speed-time').onclick = () => {
        loopSpeed = 500;
        startLoop();
      };

      // --- START THE SIMULATION ---
      
      // 1. Load Google Charts
      google.charts.load('current', {
        'packages': ['corechart']
      });

      // 2. When charts are loaded, initialize chart and start simulation
      google.charts.setOnLoadCallback(() => {
        initChart();
        startUp(compAm);
        startLoop(); // Start the main loop
      });
    </script>
  </footer>
</body>
</html>
